rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----- Public Collections -----
    
    // products: Publicly readable. Writable only under specific conditions (e.g., admin role).
    match /products/{productId} {
      allow get, list: if true;
      // Allow create/update only if it's a batch write OR the user owns the store.
      allow create, update: if false; // Not implemented yet
      // Allow delete for authenticated users (for now, for batch operations)
      allow delete: if isSignedIn();
    }

    // categories: Publicly readable. Writable only under specific conditions.
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update: if false; // Not implemented yet
      allow delete: if isSignedIn();
    }
    

    // ----- Users subcollections: only owner allowed -----

    match /users/{userId}/{document=**} {
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    // fallback: deny anything else explicitly
    match /{document=**} {
      allow read, write: if false;
    }
  }

  // ---------------- Helper functions ----------------

  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }
}
